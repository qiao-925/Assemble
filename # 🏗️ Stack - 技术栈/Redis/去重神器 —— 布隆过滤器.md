# 🔍 **去重神器 —— 布隆过滤器深度解析**

布隆过滤器是一种典型的"以小博大"的工程智慧，它不追求完美，而是在可接受的错误率下，用极低的成本解决了大数据场景下的"存在性"判断难题。

## 🎯 **应用场景：**

- 新闻客户端推荐系统如何实现推荐去重？
- 缓存穿透预防

## ⚡ **特性：**

- 不存在 → 一定不存在
- 存在 →可能不存在 （存在少量误判）

## 🔌 **REDIS 4.0开始通过插件支持。**

https://cloud.tencent.com/developer/article/2459806

## 🏗️ **实现原理： 一个很长的位数组 + 多个哈希算法。**

布隆过滤器的原理可以分为两步：**添加元素**和**查询元素**。

它的底层结构是一个很长的**位数组（bit array）和几个不同的哈希函数（hash function）**。

**初始状态**：位数组里所有位都是 0。

```
[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

```

**a. 添加元素 (例如，"apple")**

1. 拿 "apple" 这个元素，用 **3 个不同的哈希函数**分别计算它的哈希值。
2. 假设算出来的值是 `2`, `8`, `13`。
3. 将位数组中**下标为 2, 8, 13 的位置**从 0 变成 1。

现在的位数组：

```
[0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0]

```

这就完成了添加。

**b. 查询元素 (例如，查询 "apple" 和 "banana")**

**查询 "apple"：**

1. 同样用那 3 个哈希函数计算 "apple" 的哈希值，得到 `2`, `8`, `13`。
2. 检查位数组中下标为 `2`, `8`, `13` 的位置**是否都为 1**。
3. 发现它们**都是 1**，于是布隆过滤器回答："apple" **可能存在**。

**查询 "banana"：**

1. 用那 3 个哈希函数计算 "banana" 的哈希值，假设得到 `3`, `8`, `10`。
2. 检查位数组中下标为 `3`, `8`, `10` 的位置。
3. 发现下标 `3` 和 `10` 的位置是 `0`。
4. 因为**不是所有位都为 1**，所以布隆过滤器回答："banana" **绝对不存在**。

**c. 误判是如何产生的？**

假设我们后来又添加了元素 "cat"，它的哈希值恰好是 `3`, `10`, `15`。位数组变成了：

```
[0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 1]

```

现在我们再来查询从未添加过的 "banana"（哈希值为 `3`, `8`, `10`）：

- 检查下标 `3`：是 `1` (来自 "cat")。
- 检查下标 `8`：是 `1` (来自 "apple")。
- 检查下标 `10`：是 `1` (来自 "cat")。

所有位置都是 `1`！于是布隆过滤器会错误地回答 "banana" **可能存在**，这就是一次**误判**。

## ⚙️ **参数调校**

https://krisives.github.io/bloom-calculator/

根据

- 数据量
- 误判率

计算

- 位数组大小
- 哈希函数数量