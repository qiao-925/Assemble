# ğŸ”’ **Redisåˆ†å¸ƒå¼é”æ·±åº¦è§£æä¸æœ€ä½³å®è·µ**

## â° **å…³é”®æ—¶é—´èŠ‚ç‚¹**
- **Redis 2.8ä¹‹å‰**ï¼šsetnx + expire ä¸¤æ­¥æ“ä½œï¼Œå­˜åœ¨åŸå­æ€§é—®é¢˜
- **Redis 2.8+**ï¼šSET key value EX seconds NX åŸå­å‘½ä»¤ï¼Œè§£å†³æ ¸å¿ƒé—®é¢˜
- **åç»­å‘å±•**ï¼šRedissonç­‰å®¢æˆ·ç«¯åº“å¼•å…¥Watchdogæœºåˆ¶ï¼Œè§£å†³é•¿æ—¶é—´ä»»åŠ¡é—®é¢˜

## ğŸ§  **æ ¸å¿ƒå†…å®¹é€ŸæŸ¥è¡¨**

| é—®é¢˜ç±»å‹ | è§£å†³æ–¹æ¡ˆ | å…³é”®å‘½ä»¤ | é€‚ç”¨åœºæ™¯ |
|---------|---------|----------|----------|
| æ­»é”é—®é¢˜ | è¿‡æœŸæ—¶é—´æœºåˆ¶ | `SET key value EX seconds NX` | ç”Ÿäº§ç¯å¢ƒå¿…å¤‡ |
| åŸå­æ€§é—®é¢˜ | Redis 2.8+åŸå­å‘½ä»¤ | `SET key value EX seconds NX` | é«˜å¹¶å‘åœºæ™¯ |
| ç»­çº¦é—®é¢˜ | Watchdogæœºåˆ¶ | Redissonè‡ªåŠ¨ç»­çº¦ | é•¿æ—¶é—´ä»»åŠ¡ |
| å®‰å…¨æ€§é—®é¢˜ | å”¯ä¸€å€¼æ ‡è¯† | éšæœºUUID + è¿‡æœŸæ—¶é—´ | åˆ†å¸ƒå¼ç¯å¢ƒ |

## ğŸ”„ **æŠ€æœ¯æ¼”è¿›è·¯å¾„ï¼šä»é—®é¢˜åˆ°è§£å†³æ–¹æ¡ˆ**

### ğŸ•°ï¸ **å†å²èƒŒæ™¯**
Redisåˆ†å¸ƒå¼é”çš„å‘å±•åæ˜ äº†åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„æ¼”è¿›å†ç¨‹ï¼Œä»ç®€å•çš„äº’æ–¥åˆ°å¤æ‚çš„å®¹é”™æœºåˆ¶ã€‚

### ğŸ¯ **è®¾è®¡ç›®æ ‡**
- ä¿è¯äº’æ–¥æ€§ï¼šåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”
- é˜²æ­¢æ­»é”ï¼šå³ä½¿å®¢æˆ·ç«¯å´©æºƒï¼Œé”ä¹Ÿèƒ½è‡ªåŠ¨é‡Šæ”¾
- é«˜æ€§èƒ½ï¼šæœ€å°åŒ–é”æ“ä½œçš„æ€§èƒ½å¼€é”€
- é«˜å¯ç”¨ï¼šåœ¨Redisé›†ç¾¤ç¯å¢ƒä¸‹ä¿æŒä¸€è‡´æ€§

## ğŸ§˜ **Redisåˆ†å¸ƒå¼é”è®¾è®¡å“²å­¦**

### **ç®€å•æ€§å“²å­¦**
> "ç®€å•æ€§ä¸æ˜¯ç®€å•ï¼Œè€Œæ˜¯å¤æ‚æ€§è¢«å¾ˆå¥½åœ°éšè—äº†" - è¿™æ˜¯Redisåˆ†å¸ƒå¼é”è®¾è®¡çš„æ ¸å¿ƒå“²å­¦ã€‚çœ‹ä¼¼ç®€å•çš„SETå‘½ä»¤ï¼ŒèƒŒåéšè—ç€æ·±åº¦çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ€è€ƒã€‚

- ä¸€ä¸ªSETå‘½ä»¤è§£å†³å¤šä¸ªé—®é¢˜
- é¿å…å¤æ‚çš„é”åè®®ï¼Œé™ä½ä½¿ç”¨é—¨æ§›

### **é˜²å¾¡æ€§ç¼–ç¨‹æ€æƒ³**
> "å‡è®¾ç³»ç»Ÿä¼šå¤±è´¥ï¼Œæå‰åšå¥½å®¹é”™å‡†å¤‡"

- è‡ªåŠ¨è¿‡æœŸæœºåˆ¶é˜²æ­¢æ­»é”
- å”¯ä¸€å€¼æ ‡è¯†é˜²æ­¢è¯¯åˆ é”

### **åŸå­æ€§ä¼˜å…ˆåŸåˆ™**
> "ä¸€ä¸ªæ“ä½œè¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥ï¼Œæ²¡æœ‰ä¸­é—´çŠ¶æ€"

- é¿å…ä¸­é—´çŠ¶æ€å¯¼è‡´çš„ç«æ€æ¡ä»¶
- ä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§

## ğŸ—ï¸ **å®ç°åŸç†ï¼šï¼ˆåŸå­æ“ä½œï¼‰**

SETå‘½ä»¤å’ŒNXå‚æ•°ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™set,å¦åˆ™è·³è¿‡ï¼‰ï¼Œä½¿ç”¨å®Œåï¼Œé€šè¿‡delæŒ‡ä»¤é‡Šæ”¾é”

**ğŸ”— æŠ€æœ¯è®ºæ®ï¼š**
- [Rediså®˜æ–¹æ–‡æ¡£ - SETå‘½ä»¤](https://redis.io/commands/set/) - æƒå¨çš„SETå‘½ä»¤è¯´æ˜
- [Rediså®˜æ–¹æ–‡æ¡£ - NXå‚æ•°è¯´æ˜](https://redis.io/commands/setnx/) - è¯¦ç»†çš„NXå‚æ•°æ–‡æ¡£

**ğŸ’­ è®¾è®¡å“²å­¦æ€è€ƒ**ï¼šä¸ºä»€ä¹ˆé€‰æ‹©SETè€Œä¸æ˜¯å…¶ä»–å‘½ä»¤ï¼Ÿè¿™ä½“ç°äº†Redis"ç®€å•å³ç¾"çš„è®¾è®¡ç†å¿µï¼Œä¸€ä¸ªå‘½ä»¤è§£å†³å¤šä¸ªé—®é¢˜ã€‚


### âš™ï¸ **æŠ€æœ¯å®ç°**

#### 1ï¸âƒ£ **ä¸ºä»€ä¹ˆéœ€è¦åŠ è¿‡æœŸæ—¶é—´ï¼Ÿ**

åŠ é”åç¨‹åºæ‰§è¡Œå¼‚å¸¸ï¼ŒdelæŒ‡ä»¤æ— æ³•æ‰§è¡Œï¼Œé™·å…¥æ­»é”çŠ¶æ€ã€‚

**ğŸ”— æŠ€æœ¯è®ºæ®ï¼š**
- [Rediså®˜æ–¹æ–‡æ¡£ - è¿‡æœŸæ—¶é—´æœºåˆ¶](https://redis.io/commands/expire/) - å®˜æ–¹è¿‡æœŸæ—¶é—´å®ç°åŸç†
- [Martin Kleppmannçš„åˆ†å¸ƒå¼é”åˆ†æ](https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html) - æƒå¨æŠ€æœ¯åšå®¢ï¼Œæ·±åº¦åˆ†ææ­»é”é—®é¢˜
- [Rediså®˜æ–¹åˆ†å¸ƒå¼é”å®‰å…¨æŒ‡å—](https://redis.io/topics/distlock#safety-requirements) - å®˜æ–¹å®‰å…¨æœ€ä½³å®è·µ

**ğŸ’­ è®¾è®¡å“²å­¦æ€è€ƒ**ï¼šè¿™æ˜¯å…¸å‹çš„"é˜²å¾¡æ€§ç¼–ç¨‹"æ€æƒ³ï¼Œå‡è®¾ç³»ç»Ÿä¼šå¤±è´¥ï¼Œæå‰åšå¥½å®¹é”™å‡†å¤‡ã€‚

#### 2ï¸âƒ£ **setnxå‘½ä»¤å’Œexpireå‘½ä»¤çš„åŸå­æ€§é—®é¢˜**

setnxå‘½ä»¤æ‰§è¡Œåï¼Œç¨‹åºå¼‚å¸¸ï¼Œæ— æ³•æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Ÿ

```
SET key value EX seconds NX
```

redis 2.8å°†ä¸¤ä¸ªå‘½ä»¤åˆå¹¶ä¸ºä¸€ä¸ªåŸå­å‘½ä»¤ã€‚

**ğŸ”— æŠ€æœ¯è®ºæ®ï¼š**
- [Redis 2.8ç‰ˆæœ¬æ›´æ–°æ—¥å¿—](https://raw.githubusercontent.com/redis/redis/2.8/00-RELEASENOTES) - **é«˜ä¼˜å…ˆçº§**ï¼šç›´æ¥è¯æ˜åŸå­æ€§æ”¹è¿›çš„å†å²äº‹å®
- [Rediså®˜æ–¹æ–‡æ¡£ - SETå‘½ä»¤åŸå­æ€§](https://redis.io/commands/set/) - å®˜æ–¹åŸå­æ€§å®ç°è¯´æ˜
- [Stack Overflowè®¨è®º - åŸå­æ€§å®ç°](https://stackoverflow.com/questions/2955402/redis-setnx-and-expire-atomicity) - ç¤¾åŒºè®¨è®ºå’Œè§£å†³æ–¹æ¡ˆ

**ğŸ’­ è®¾è®¡å“²å­¦æ€è€ƒ**ï¼šè¿™ä½“ç°äº†"åŸå­æ€§"åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é‡è¦æ€§ï¼Œä¸€ä¸ªæ“ä½œè¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥ï¼Œæ²¡æœ‰ä¸­é—´çŠ¶æ€ã€‚

#### 3ï¸âƒ£ **è¿‡æœŸæ—¶é—´å°äºç¨‹åºçš„æ“ä½œæ—¶é—´ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ**

**ç¨‹åºçš„é¢„è®¡å¤„ç†æ—¶é—´å’Œè¿‡æœŸæ—¶é—´çš„çµæ´»æ§åˆ¶ï¼ˆåŠ¨æ€é—®é¢˜ï¼‰**

- **æ‰‹åŠ¨å¤„ç†**ï¼šå¯¹ä¸šåŠ¡å¤„ç†æ—¶é—´è¿›è¡Œåˆç†é¢„ä¼°ï¼Œæ§åˆ¶è¿‡æœŸæ—¶é—´å’Œç¨‹åºå¤„ç†æ—¶é—´çš„å¹³è¡¡ã€‚
- **å¼•å…¥ç»­çº¦é”æœºåˆ¶**ï¼š
    - Redissionæ”¯æŒwatch dogæœºåˆ¶è½®è¯¢ï¼ˆé»˜è®¤é‡Šæ”¾æ—¶é—´1/3ï¼‰å’Œæ›´æ–°ï¼ˆé‡ç½®ï¼‰é”çš„è¿‡æœŸæ—¶é—´ã€‚
    - Redissioné—®é¢˜ï¼šå¦‚æœä»»åŠ¡ä¸€ç›´æ²¡å®Œæˆï¼Œä¼šå¯¼è‡´æå¤§çš„é˜»å¡ã€‚

**ğŸ”— æŠ€æœ¯è®ºæ®ï¼š**
- [Redissonå®˜æ–¹æ–‡æ¡£ - Watchdogæœºåˆ¶](https://github.com/redisson/redisson/wiki/8.-distributed-locks-and-synchronizers) - å®˜æ–¹Watchdogå®ç°è¯´æ˜
- [Redissonå®˜æ–¹æ–‡æ¡£ - è‡ªåŠ¨ç»­çº¦](https://github.com/redisson/redisson/wiki/8.-distributed-locks-and-synchronizers#81-redisåˆ†å¸ƒå¼é”) - è‡ªåŠ¨ç»­çº¦æœºåˆ¶è¯¦è§£
- [Rediså®˜æ–¹æ–‡æ¡£ - é”ç»­çº¦æœ€ä½³å®è·µ](https://redis.io/topics/distlock#correctness-arguments) - å®˜æ–¹ç»­çº¦ç­–ç•¥æŒ‡å¯¼

**ğŸ’­ è®¾è®¡å“²å­¦æ€è€ƒ**ï¼šè¿™æ˜¯"åŠ¨æ€é€‚åº”"æ€æƒ³çš„ä½“ç°ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®å®é™…è¿è¡Œæƒ…å†µè°ƒæ•´è‡ªå·±çš„è¡Œä¸ºã€‚

## ğŸ”— **çŸ¥è¯†ç½‘ç»œè¿æ¥**

### **ä¸å…¶ä»–RedisæŠ€æœ¯çš„å…³è”**
- **å†…å­˜ç®¡ç†**ï¼šåˆ†å¸ƒå¼é”çš„è¿‡æœŸæ—¶é—´ä¸Redisçš„å†…å­˜ç®¡ç†ç­–ç•¥å¯†åˆ‡ç›¸å…³
- **æŒä¹…åŒ–**ï¼šåœ¨Redisé‡å¯åï¼Œåˆ†å¸ƒå¼é”çš„çŠ¶æ€å¦‚ä½•ä¿æŒï¼Ÿ
- **é›†ç¾¤æ¨¡å¼**ï¼šRedis Clusterä¸­çš„åˆ†å¸ƒå¼é”å®ç°æœ‰ä½•ä¸åŒï¼Ÿ
- **Luaè„šæœ¬**ï¼šå¦‚ä½•ä½¿ç”¨Luaè„šæœ¬å®ç°æ›´å¤æ‚çš„åˆ†å¸ƒå¼é”é€»è¾‘ï¼Ÿ

### **ä¸åˆ†å¸ƒå¼ç³»ç»Ÿæ¦‚å¿µçš„å…³è”**
- **CAPç†è®º**ï¼šRedisåˆ†å¸ƒå¼é”åœ¨ä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§ä¹‹é—´çš„æƒè¡¡
- **æ—¶é’Ÿæ¼‚ç§»**ï¼šä¸åŒæœåŠ¡å™¨ä¹‹é—´çš„æ—¶é—´å·®å¼‚å¯¹åˆ†å¸ƒå¼é”çš„å½±å“
- **ç½‘ç»œåˆ†åŒº**ï¼šç½‘ç»œæ•…éšœæ—¶åˆ†å¸ƒå¼é”çš„è¡Œä¸ºåˆ†æ

## ğŸ­ **æ–¹æ¡ˆå¤šæ ·æ€§ï¼šä¸åŒåœºæ™¯ä¸‹çš„é€‰æ‹©**

### **åœºæ™¯1ï¼šé«˜å¹¶å‘çŸ­ä»»åŠ¡**
- **æ¨èæ–¹æ¡ˆ**ï¼š`SET key value EX seconds NX`
- **ä¼˜åŠ¿**ï¼šç®€å•ã€é«˜æ•ˆã€RedisåŸç”Ÿæ”¯æŒ
- **é€‚ç”¨**ï¼šç§’æ€ã€é™æµç­‰åœºæ™¯

### **åœºæ™¯2ï¼šé•¿æ—¶é—´ä»»åŠ¡**
- **æ¨èæ–¹æ¡ˆ**ï¼šRedisson Watchdogæœºåˆ¶
- **ä¼˜åŠ¿**ï¼šè‡ªåŠ¨ç»­çº¦ã€é˜²æ­¢æ„å¤–è¿‡æœŸ
- **é€‚ç”¨**ï¼šæ‰¹å¤„ç†ã€é•¿æ—¶é—´è®¡ç®—ç­‰åœºæ™¯

### **åœºæ™¯3ï¼šé«˜å¯ç”¨è¦æ±‚**
- **æ¨èæ–¹æ¡ˆ**ï¼šRedis Cluster + å¤šèŠ‚ç‚¹é”
- **ä¼˜åŠ¿**ï¼šé«˜å¯ç”¨ã€æ•…éšœè½¬ç§»
- **é€‚ç”¨**ï¼šé‡‘èã€ç”µå•†ç­‰å…³é”®ä¸šåŠ¡

## ğŸš€ **å®è·µéªŒè¯ï¼šä»£ç ç¤ºä¾‹**

### **åŸºç¡€å®ç°**
```python
import redis
import uuid
import time

class RedisDistributedLock:
    def __init__(self, redis_client, lock_name, expire_time=30):
        self.redis = redis_client
        self.lock_name = f"lock:{lock_name}"
        self.expire_time = expire_time
        self.lock_value = str(uuid.uuid4())
    
    def acquire(self):
        """è·å–é”"""
        result = self.redis.set(
            self.lock_name, 
            self.lock_value, 
            ex=self.expire_time, 
            nx=True
        )
        return result is not None
    
    def release(self):
        """é‡Šæ”¾é”ï¼ˆä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰"""
        lua_script = """
        if redis.call("get", KEYS[1]) == ARGV[1] then
            return redis.call("del", KEYS[1])
        else
            return 0
        end
        """
        return self.redis.eval(lua_script, 1, self.lock_name, self.lock_value)
    
    def __enter__(self):
        if not self.acquire():
            raise Exception("Failed to acquire lock")
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        self.release()

# ä½¿ç”¨ç¤ºä¾‹
with RedisDistributedLock(redis_client, "my_task", 60):
    # æ‰§è¡Œéœ€è¦åŠ é”çš„ä»»åŠ¡
    print("Task executing...")
    time.sleep(10)
```

### **è¿›é˜¶ï¼šè‡ªåŠ¨ç»­çº¦æœºåˆ¶**
```python
import threading
import time

class AutoRenewLock(RedisDistributedLock):
    def __init__(self, redis_client, lock_name, expire_time=30, renew_interval=10):
        super().__init__(redis_client, lock_name, expire_time)
        self.renew_interval = renew_interval
        self.renew_thread = None
        self.running = False
    
    def start_renewal(self):
        """å¯åŠ¨è‡ªåŠ¨ç»­çº¦çº¿ç¨‹"""
        self.running = True
        self.renew_thread = threading.Thread(target=self._renew_loop)
        self.renew_thread.daemon = True
        self.renew_thread.start()
    
    def _renew_loop(self):
        """ç»­çº¦å¾ªç¯"""
        while self.running:
            time.sleep(self.renew_interval)
            if self.running:
                self._renew()
    
    def _renew(self):
        """ç»­çº¦æ“ä½œ"""
        lua_script = """
        if redis.call("get", KEYS[1]) == ARGV[1] then
            return redis.call("expire", KEYS[1], ARGV[2])
        else
            return 0
        end
        """
        result = self.redis.eval(lua_script, 1, self.lock_name, self.lock_value, self.expire_time)
        if result == 0:
            self.running = False
    
    def __enter__(self):
        if super().__enter__():
            self.start_renewal()
            return self
        return None
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        self.running = False
        if self.renew_thread:
            self.renew_thread.join()
        super().__exit__(exc_type, exc_val, exc_tb)
```

## ğŸ­ **å®è·µéªŒè¯åœºæ™¯**

### **åœºæ™¯1ï¼šç§’æ€ç³»ç»Ÿ**
- **é—®é¢˜**ï¼šé«˜å¹¶å‘ä¸‹é˜²æ­¢è¶…å–
- **éªŒè¯**ï¼šæ¨¡æ‹Ÿ1000ä¸ªå¹¶å‘è¯·æ±‚ï¼ŒéªŒè¯é”çš„äº’æ–¥æ€§
- **å…³é”®æŒ‡æ ‡**ï¼šé”è·å–æˆåŠŸç‡ã€å“åº”æ—¶é—´ã€åº“å­˜ä¸€è‡´æ€§

### **åœºæ™¯2ï¼šåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦**
- **é—®é¢˜**ï¼šé˜²æ­¢é‡å¤æ‰§è¡Œ
- **éªŒè¯**ï¼šæ¨¡æ‹Ÿç½‘ç»œåˆ†åŒºï¼ŒéªŒè¯é”çš„å¯é æ€§
- **å…³é”®æŒ‡æ ‡**ï¼šä»»åŠ¡æ‰§è¡Œå”¯ä¸€æ€§ã€æ•…éšœæ¢å¤èƒ½åŠ›

### **åœºæ™¯3ï¼šç¼“å­˜æ›´æ–°**
- **é—®é¢˜**ï¼šé˜²æ­¢ç¼“å­˜é›ªå´©
- **éªŒè¯**ï¼šæ¨¡æ‹Ÿå¤§é‡å¹¶å‘æ›´æ–°ï¼ŒéªŒè¯é”çš„æ€§èƒ½
- **å…³é”®æŒ‡æ ‡**ï¼šç¼“å­˜ä¸€è‡´æ€§ã€æ›´æ–°æ€§èƒ½ã€é”ç«äº‰æƒ…å†µ

### **åœºæ™¯4ï¼šæ•°æ®åº“è¿æ¥æ± ç®¡ç†**
- **é—®é¢˜**ï¼šé˜²æ­¢è¿æ¥æ³„éœ²
- **éªŒè¯**ï¼šæ¨¡æ‹Ÿè¿æ¥å¼‚å¸¸æ–­å¼€ï¼ŒéªŒè¯é”çš„å®¹é”™æ€§
- **å…³é”®æŒ‡æ ‡**ï¼šè¿æ¥æ± å¤§å°ç¨³å®šæ€§ã€å¼‚å¸¸æ¢å¤èƒ½åŠ›