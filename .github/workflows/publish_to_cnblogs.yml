# .github/workflows/publish_to_cnblogs.yml

name: Publish to Cnblogs

on:
  push:
    branches:
      - main
    paths:
      - '**.md'

jobs:
  # 作业一：找出变动的文件，并将其输出为 JSON 格式
  find-changed-files:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.changed-files.outputs.files }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get changed markdown files
        id: changed-files
        run: |
          git config --global core.quotepath false
          
          FILES_LIST=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- '**.md')
          
          if [ -z "$FILES_LIST" ]; then
            echo "No markdown files changed."
            echo "files=[]" >> $GITHUB_OUTPUT
          else
            echo "Markdown files changed:"
            echo "$FILES_LIST"
          
            # 核心修复：使用纯 Shell 循环手动构建 JSON 数组，不再依赖 jq
            JSON_ARRAY="["
            FIRST=true
            # 使用 while read 循环安全地处理每一行，即使文件名包含空格
            while IFS= read -r line; do
              # 忽略空行
              if [ -z "$line" ]; then continue; fi
          
              # 转义文件名中的 " 和 \ 字符，以生成合法的 JSON 字符串
              ESCAPED_LINE=$(echo "$line" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          
              if [ "$FIRST" = false ]; then
                JSON_ARRAY="$JSON_ARRAY,"
              fi
              JSON_ARRAY="$JSON_ARRAY\"$ESCAPED_LINE\""
              FIRST=false
            done <<< "$FILES_LIST"
            JSON_ARRAY="$JSON_ARRAY]"
          
            echo "Generated JSON: $JSON_ARRAY"
            echo "files=$JSON_ARRAY" >> $GITHUB_OUTPUT
          fi

  # 作业二：根据上一步的文件列表，为每个文件执行发布脚本
  publish-files:
    needs: find-changed-files
    if: ${{ needs.find-changed-files.outputs.files != '[]' }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        file: ${{ fromJSON(needs.find-changed-files.outputs.files) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Publish '${{ matrix.file }}' to Cnblogs
        env:
          CNBLOGS_RPC_URL: ${{ secrets.CNBLOGS_RPC_URL }}
          CNBLOGS_BLOG_ID: ${{ secrets.CNBLOGS_BLOG_ID }}
          CNBLOGS_USERNAME: ${{ secrets.CNBLOGS_USERNAME }}
          CNBLOGS_PASSWORD: ${{ secrets.CNBLOGS_PASSWORD }}
        run: |
          python scripts/sync_to_cnblogs.py "${{ matrix.file }}"
